name: jupyterlab-offline

commands:
  lab:
    description: run lab as installed
    unix: jupyter lab --no-browser --debug
    env_spec: user

  build:
    description: build everything
    env_spec: _dev
    unix: anaconda-project run build:offline && anaconda-project run build:ext
    # anaconda-project run build:lab &&

  build:lab:
    description: build the hacked local jupyterlab package
    env_spec: _dev
    unix: conda-build -c conda-forge conda.recipes/jupyterlab

  build:offline:
    description: build the offline lab package
    env_spec: _dev
    unix: conda build -c conda-forge conda.recipes/jupyterlab-offline

  build:ext:
    description: build the offline labextension packages
    env_spec: _dev
    unix: cd conda.recipes
      && conda build -c conda-forge  jupyterlab-offline-jupyter-widgets-jupyterlab-manager
      && conda build -c conda-forge jupyterlab-offline-bqplot
      && conda build -c conda-forge jupyterlab-offline-ipyvolume
      && conda build -c conda-forge jupyterlab-offline-jupyter-threejs
      && conda build -c conda-forge jupyterlab-offline-jupyter-leaflet
      && conda build -c conda-forge jupyterlab-offline-jupyterlab-toc

  build:noarch:
    description: fix up the _dev/conda-bld to squelch errors
    unix: >
      mkdir -p $CONDA_PREFIX/conda-bld/noarch && echo '{"info": {}, "packages": {}}' > $CONDA_PREFIX/conda-bld/noarch/repodata.json
    env_spec: _dev

  pretest:setup:
    env_spec: _hack
    unix: cd jupyterlab-offline && pip install -e . --no-deps --ignore-installed
  test:offline-base:
    env_spec: _hack
    unix: jupyter laboffline
  test:offline-widgets:
    env_spec: _hack
    unix: jupyter laboffline --extension="@jupyter-widgets/jupyterlab-manager" --name="jupyter-widgets-jupyterlab-manager"
  test:offline-bqplot:
    env_spec: _hack
    unix: jupyter laboffline --extension="bqplot" --name="bqplot"
  test:offline-pythreejs:
    env_spec: _hack
    unix: jupyter laboffline --extension="jupyter-threejs" --name="jupyter-threejs"
  test:offline-ipyvolume:
    env_spec: _hack
    unix: jupyter laboffline --extension="ipyvolume" --name="ipyvolume"
  posttest:teardown:
    env_spec: _hack
    unix: rm -rf ${CONDA_PREFIX}/share/jupyter
  test:
    env_spec: _hack
    unix: anaconda-project run posttest:teardown && anaconda-project run pretest:setup && anaconda-project run test:offline-base && anaconda-project run test:offline-widgets && anaconda-project run test:offline-bqplot

channels:
- conda-forge
- defaults

env_specs:
  _dev:
    inherit_from:
    - _lab
    - _py
    packages:
    - conda-build ==2.1.8
    - python >=3.6,<3.7
    - anaconda-project

  _hack:
    inherit_from:
      - _dev
    packages:
    - diffoscope
    - hypothesis
    - pandas
    - anaconda-project
    - sh
    - nodejs
    - giflib
    - libpng

  _lab:
    packages:
      - jupyterlab ==0.31.12

  _py:
    packages:
      - python >=3.6,<3.7

  user:
    channels:
    - ./envs/default/conda-bld
    - conda-forge
    - defaults
    inherit_from:
    - _lab
    - _py

  user-offline:
    inherit_from:
    - user
    packages:
    - jupyterlab-offline

  user-widgets:
    inherit_from:
    - user-offline
    packages:
    - jupyterlab-offline-jupyter-widgets-jupyterlab-manager

  user-bqplot:
    inherit_from:
    - user-widgets
    packages:
    - jupyterlab-offline-bqplot

  user-sink:
    inherit_from:
    - user-widgets
    packages:
    - jupyterlab-offline-bqplot
    - jupyterlab-offline-ipyvolume
    - jupyterlab-offline-jupyter-leaflet
    - jupyterlab-offline-jupyter-threejs
    - jupyterlab-offline-jupyterlab-toc

skip_imports:
  environment: f76a74a4c26dff0fa9cbb82199295495b68b87ba
